<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - negociApp</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css" />

    <!-- Icons -->
    <div id="modalTenantDetails" class="modal hidden">
      <div class="modal-content" id="tenantModalContent">
        <!-- Content Rendered via JS -->
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal hidden">
      <div class="modal-content confirmation-modal-content">
        <div class="confirmation-modal-header">
          <h2 id="confirmationTitle">Confirmar acci칩n</h2>
        </div>
        <div class="confirmation-modal-body">
          <p id="confirmationMessage">쮼st치s seguro?</p>
        </div>
        <div class="confirmation-modal-footer">
          <button id="btnCancelConfirmation" class="btn btn-secondary">
            Cancelar
          </button>
          <button id="btnConfirmAction" class="btn btn-danger-bright">
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
  </head>
  <body class="dashboard-body">
    <div class="dashboard-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="brand-header-sm">
          <h2 class="logo-text-sm">negoci<span class="highlight">App</span></h2>
        </div>

        <nav class="nav-menu">
          <a href="#" class="nav-item active" data-section="welcome">
            <i class="ph ph-squares-four"></i> Inicio
          </a>

          <!-- Admin Only -->
          <div id="nav-admin" class="nav-section hidden">
            <span class="nav-label">Plataforma</span>
            <a href="#" class="nav-item" data-section="tenants"
              ><i class="ph ph-buildings"></i> Empresas</a
            >
            <a href="#" class="nav-item" data-section="users"
              ><i class="ph ph-users"></i> Usuarios</a
            >
            <a href="#" class="nav-item" data-section="payments" id="navLinkPayments"
              ><div style="position: relative; display: inline-block;"><i class="ph ph-money"></i></div> Pagos <span id="sidebarPaymentsBadge" class="sidebar-badge-dot hidden" style="width: 8px; height: 8px; background-color: var(--warning-color, #f59e0b); border-radius: 50%; display: inline-block; margin-left: auto;"></span></a
            >
            <a href="#" class="nav-item" data-section="notifications" id="navLinkNotificationsAdmin"
              ><div style="position: relative; display: inline-block;"><i class="ph ph-bell"></i></div> Notificaciones <span id="sidebarNotificationsBadgeAdmin" class="sidebar-badge-dot hidden" style="width: 8px; height: 8px; background-color: var(--warning-color, #f59e0b); border-radius: 50%; display: inline-block; margin-left: auto;"></span></a
            >
          </div>

          <!-- Company Only -->
          <div id="nav-company" class="nav-section hidden">
            <span class="nav-label">Mi Negocio</span>
            <a href="#" class="nav-item" data-section="employees"
              ><i class="ph ph-users-three"></i> Empleados</a
            >
            <a href="#" class="nav-item" data-section="notifications" id="navLinkNotificationsCompany"
              ><div style="position: relative; display: inline-block;"><i class="ph ph-bell"></i></div> Notificaciones <span id="sidebarNotificationsBadgeCompany" class="sidebar-badge-dot hidden" style="width: 8px; height: 8px; background-color: var(--warning-color, #f59e0b); border-radius: 50%; display: inline-block; margin-left: auto;"></span></a
            >
            <a href="#" class="nav-item" data-section="inventory"
              ><i class="ph ph-package"></i> Inventario</a
            >
            <a href="#" class="nav-item" data-section="sales"
              ><i class="ph ph-currency-dollar"></i> Ventas</a
            >
            <a href="#" class="nav-item" data-section="subscription"
              ><i class="ph ph-receipt"></i> Suscripci칩n</a
            >
          </div>

          <!-- Employee Only -->
          <div id="nav-employee" class="nav-section hidden">
            <span class="nav-label">Operativo</span>
            <a href="#" class="nav-item" data-section="stock"
              ><i class="ph ph-barcode"></i> Stock</a
            >
            <a href="#" class="nav-item" data-section="new-sale"
              ><i class="ph ph-shopping-cart"></i> Nueva Venta</a
            >
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="user-mini-profile">
            <div class="avatar-circle">
              <span id="userInitials">U</span>
            </div>
            <div class="user-info">
              <p id="userName" class="user-name">Cargando...</p>
              <p id="userRole" class="user-role">...</p>
            </div>
          </div>
          <button id="logoutBtn" class="btn-logout" title="Cerrar Sesi칩n">
            <i class="ph ph-sign-out"></i>
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <h1 id="pageTitle">Bienvenido</h1>
          <div class="top-actions">

            <button
              class="btn-primary"
              onclick="openUserProfileModal()"
              title="Mi Usuario"
              style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;"
            >
              <i class="ph ph-user"></i> Mi Usuario
            </button>
          </div>
        </header>

        <div class="content-wrapper">
          <!-- Welcome Section (Default) -->
          <section id="welcome-panel" class="dashboard-card">
            <h2>Hola, <span id="welcomeName">Usuario</span> 游녦</h2>
            <p>Aqu칤 tienes un resumen de la actividad reciente.</p>

            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-label">Estado</span>
                <span class="stat-value highlight">Activo</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Rol</span>
                <span id="statRole" class="stat-value">...</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Tenant</span>
                <span id="statTenant" class="stat-value">...</span>
              </div>
            </div>
          </section>

          <!-- Dynamic Content Container -->
          <div id="dynamic-content"></div>
        </div>
      </main>
    </div>

    <!-- Modal Create Tenant -->
    <div id="modalCreateTenant" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Registrar Nueva Empresa</h2>
          <button class="btn-close-modal"><i class="ph ph-x"></i></button>
        </div>
        <form id="formCreateTenant">
          <div class="form-section">
            <h3>Datos de la Empresa</h3>
            <div class="form-group">
              <label for="tenantName">Nombre de Empresa</label>
              <input
                type="text"
                id="tenantName"
                name="name"
                required
                placeholder="Ej. Tech Solutions S.A."
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="tenantEmail">Email de Contacto</label>
                <input
                  type="email"
                  id="tenantEmail"
                  name="contact_email"
                  required
                  placeholder="contacto@empresa.com"
                />
              </div>
              <div class="form-group">
                <label for="tenantPhone">Tel칠fono (Opcional)</label>
                <div style="display: flex; gap: 10px; align-items: center">
                  <span
                    style="
                      background: var(--bg-card);
                      padding: 0.5rem;
                      border: 1px solid var(--border-color);
                      border-radius: var(--radius);
                      color: var(--text-muted);
                      white-space: nowrap;
                    "
                    >+54 9</span
                  >
                  <input
                    type="tel"
                    id="tenantPhone"
                    name="phone_number_suffix"
                    placeholder="11 1234 5678"
                    style="flex-grow: 1"
                  />
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="tenantPlan">Tipo de Plan</label>
              <select id="tenantPlan" name="plan_type" required>
                <option value="FREE_TRIAL_1_MONTH" selected>
                  Prueba Gratis (1 Mes)
                </option>
                <option value="FREE_FOREVER">Gratis por siempre</option>
                <option value="PAID_MONTHLY">Pago Mensual</option>
                <option value="PAID_YEARLY">Pago Anual</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tenantContactName">Nombre del Contacto</label>
              <input
                type="text"
                id="tenantContactName"
                name="contact_name"
                required
                placeholder="Persona de referencia"
              />
            </div>
          </div>

          <div class="form-section">
            <h3>Usuario Administrador</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="adminName">Nombre Completo</label>
                <input
                  type="text"
                  id="adminName"
                  name="full_name"
                  required
                  placeholder="Nombre Apellido"
                />
              </div>
              <div class="form-group">
                <label for="adminUsername">Usuario</label>
                <input
                  type="text"
                  id="adminUsername"
                  name="username"
                  required
                  placeholder="usuario_admin"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="adminPassword">Contrase침a</label>
              <input
                type="password"
                id="adminPassword"
                name="password"
                required
                placeholder="******"
              />
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-secondary btn-cancel-modal">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">Crear Empresa</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Create Payment -->
    <div id="modalCreatePayment" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Nuevo Pago</h2>
                <button class="btn-close-modal" onclick="closePaymentModal()"><i class="ph ph-x"></i></button>
            </div>
            <form id="formCreatePayment">
                <div class="form-section">
                    <div class="form-group">
                        <label for="paymentAmount">Monto</label>
                        <input type="number" id="paymentAmount" name="amount" required placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="paymentPeriod">Periodo (Mes/A침o)</label>
                        <input type="month" id="paymentPeriod" name="payment_period" required>
                        <small style="color:var(--text-muted)">Seleccione el mes a pagar</small>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">Tipo de Pago</label>
                        <select id="paymentType" name="type" required>
                            <option value="PAGO_MENSUAL">Pago Mensual</option>
                            <option value="PAGO_ANUAL">Pago Anual</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentFile">Comprobante de Transferencia</label>
                        <input type="file" id="paymentFile" name="file" required accept="image/*,application/pdf">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closePaymentModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Registrar Pago</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal My User Profile -->
    <div id="modalUserProfile" class="modal hidden">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2>Mi Usuario</h2>
          <button class="btn-close-modal" onclick="closeUserProfileModal()">
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- User Details Section -->
          <div
            class="user-details-card"
            style="
              background: var(--bg-card);
              padding: 1rem;
              border-radius: var(--radius);
              margin-bottom: 1.5rem;
              border: 1px solid var(--border-color);
            "
          >
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--color-primary);">
              Mis Datos
            </h3>
            <div style="display: grid; gap: 0.8rem;">
              <div>
                <span style="font-weight: 600; color: var(--text-muted);">Nombre:</span>
                <span id="profileFullName" style="margin-left: 0.5rem;">-</span>
              </div>
              <div>
                <span style="font-weight: 600; color: var(--text-muted);">Usuario:</span>
                <span id="profileUsername" style="margin-left: 0.5rem;">-</span>
              </div>
              <div>
                <span style="font-weight: 600; color: var(--text-muted);">Rol:</span>
                <span id="profileRole" style="margin-left: 0.5rem;">-</span>
              </div>
              <div id="profileTenantRow" class="hidden">
                <span style="font-weight: 600; color: var(--text-muted);">Empresa:</span>
                <span id="profileTenant" style="margin-left: 0.5rem;">-</span>
              </div>
            </div>
          </div>

          <!-- Change Password Trigger -->
          <div id="btnChangePasswordContainer" style="text-align: center; margin-bottom: 1rem;">
             <button class="btn-secondary" onclick="togglePasswordForm(true)" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i class="ph ph-lock-key"></i> Cambiar Contrase침a
             </button>
          </div>

          <!-- Change Password Form (Hidden by default) -->
          <div id="passwordFormContainer" class="hidden" style="background: #f9f9f9; padding: 1rem; border-radius: 8px; border: 1px dashed #ccc;">
              <form id="formChangePassword">
                <h3 style="margin-bottom: 1rem; font-size: 1rem;">Nueva Contrase침a</h3>
                
                <!-- Horizontal Label-Input Layout -->
                <div style="display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem;">
                    
                    <!-- Row 1 -->
                    <div class="form-group" style="display: grid; grid-template-columns: 140px 1fr; align-items: center; gap: 1rem; margin-bottom: 0;">
                      <label for="currentPassword" style="font-size:0.9rem; margin-bottom: 0;">Contrase침a Actual</label>
                      <input
                        type="password"
                        id="currentPassword"
                        name="current_password"
                        required
                        placeholder="******"
                        style="width:100%;"
                      />
                    </div>

                    <!-- Row 2 -->
                    <div class="form-group" style="display: grid; grid-template-columns: 140px 1fr; align-items: center; gap: 1rem; margin-bottom: 0;">
                      <label for="newPassword" style="font-size:0.9rem; margin-bottom: 0;">Nueva Contrase침a</label>
                      <input
                        type="password"
                        id="newPassword"
                        name="new_password"
                        required
                        placeholder="******"
                        style="width:100%;"
                      />
                    </div>

                    <!-- Row 3 -->
                    <div class="form-group" style="display: grid; grid-template-columns: 140px 1fr; align-items: center; gap: 1rem; margin-bottom: 0;">
                      <label for="confirmNewPassword" style="font-size:0.9rem; margin-bottom: 0;">Confirmar Nueva</label>
                      <input
                        type="password"
                        id="confirmNewPassword"
                        name="confirm_new_password"
                        required
                        placeholder="******"
                        style="width:100%;"
                      />
                    </div>
                </div>

                <div class="modal-footer" style="padding: 0; justify-content: flex-end; gap: 0.5rem;">
                  <button
                    type="button"
                    class="btn-secondary"
                    onclick="togglePasswordForm(false)"
                  >
                    Cancelar
                  </button>
                  <button type="submit" class="btn-primary">Confirmar</button>
                </div>
              </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Resolve Reset Password -->
    <div id="modalResolveResetPassword" class="modal hidden">
        <div class="modal-content" style="max-width: 680px; height: auto; max-height: 90vh;">
            <div class="modal-header">
                <h2>Resolver Cambio de Contrase침a</h2>
                <button class="btn-close-modal" onclick="closeResolvePasswordModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                
                <div style="margin: 1.5rem 1.5rem 0.375rem 1.5rem;">
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 1.5rem; display: grid; gap: 0.5rem;">
                        <div><strong>Usuario:</strong> <span id="resolveUser">-</span></div>
                        <div><strong>Rol:</strong> <span id="resolveRole">-</span></div>
                        <div><strong>Empresa:</strong> <span id="resolveTenant">-</span></div>
                    </div>

                    <form id="formResolvePassword">
                        <input type="hidden" id="resolveNotificationId">
                        <input type="hidden" id="resolveUserId">
                        
                        <div class="form-group">
                            <label for="resolveNewPassword">Contrase침a Nueva</label>
                            <input type="password" id="resolveNewPassword" name="new_password" required placeholder="******">
                        </div>
                        <div class="form-group">
                            <label for="resolveConfirmPassword">Confirmar nueva contrase침a</label>
                            <input type="password" id="resolveConfirmPassword" name="confirm_password" required placeholder="******">
                        </div>

                        <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: center; padding: 0.75rem; margin-top: 1rem;">
                            <button type="button" class="btn-secondary" onclick="closeResolvePasswordModal()" style="width: 25%;">Cancelar</button>
                            <button type="submit" class="btn-primary" style="width: 25%; background-color: #2fb344 !important; border-color: #2fb344 !important;">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script type="module" src="js/dashboard.js"></script>
  </body>
</html>
